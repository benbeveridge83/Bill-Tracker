import 'dotenv/config';
import express from 'express';
import cors from 'cors';
import { google } from 'googleapis';

const app = express();
app.use(cors());
app.use(express.json());

const gmailScopes = ['https://www.googleapis.com/auth/gmail.readonly'];
let gmailToken = null; // TODO: store per-user in a DB

function googleOAuth(){
  return new google.auth.OAuth2(
    process.env.GOOGLE_CLIENT_ID,
    process.env.GOOGLE_CLIENT_SECRET,
    process.env.GOOGLE_REDIRECT_URI
  );
}

app.get('/auth/gmail/start', (req,res)=>{
  const oAuth2Client = googleOAuth();
  const url = oAuth2Client.generateAuthUrl({ access_type: 'offline', scope: gmailScopes, prompt: 'consent' });
  res.redirect(url);
});

app.get('/auth/gmail/callback', async (req,res)=>{
  try{
    const oAuth2Client = googleOAuth();
    const { code } = req.query;
    const { tokens } = await oAuth2Client.getToken(code);
    gmailToken = tokens; // persist in DB
    res.send('<script>window.close && window.close();</script> Linked Gmail. You can close this tab.');
  }catch(e){
    console.error(e);
    res.status(500).send('OAuth error');
  }
});

app.get('/api/mail/fetch', async (req,res)=>{
  try{
    if(!gmailToken) return res.status(401).json({ error: 'not_linked' });
    const oAuth2Client = googleOAuth(); oAuth2Client.setCredentials(gmailToken);
    const gmail = google.gmail({version:'v1', auth: oAuth2Client});
    const q = `newer_than:45d (subject:(statement) OR subject:(bill) OR subject:(invoice) OR subject:(due) OR subject:(payment))`;
    const list = await gmail.users.messages.list({ userId: 'me', q, maxResults: 50 });
    const items = [];
    for(const m of (list.data.messages||[])){
      const msg = await gmail.users.messages.get({ userId:'me', id:m.id, format:'full' });
      const headers = Object.fromEntries((msg.data.payload.headers||[]).map(h=>[h.name.toLowerCase(), h.value]));
      const from = headers['from']||''; const subject = headers['subject']||'';
      // pick a text part
      const part = (msg.data.payload.parts||[]).find(p=>p.mimeType==='text/plain') || msg.data.payload;
      const b64 = (part.body?.data||'').replace(/-/g,'+').replace(/_/g,'/');
      const body = Buffer.from(b64,'base64').toString('utf8');

      const amtMatch  = body.match(/\$\s*([\d,]+(?:\.\d{2})?)/) || subject.match(/\$\s*([\d,]+(?:\.\d{2})?)/);
      const dateMatch = body.match(/due\s*(?:date|by)?\s*[:\-]?\s*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/i) || subject.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
      const amountDue = amtMatch? Number(amtMatch[1].replace(/,/g,'')) : null;
      const dueDate   = dateMatch? new Date(dateMatch[1]) : null;

      items.push({
        provider:'gmail',
        from,
        subject,
        amountDue,
        dueDate,
        messageId:m.id,
        vendor: from.replace(/<.*?>/,'').replace(/"/g,'').trim()
      });
    }
    res.json({ items });
  }catch(e){
    console.error(e);
    res.status(500).json({ error: 'mail_fetch' });
  }
});

const port = process.env.PORT || 3000;
app.listen(port, ()=> console.log('API listening on', port));

